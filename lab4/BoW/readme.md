## ***任务：收集⼀组图像，建⽴⼀个小的数据集，划分训练集和测试集，在此基础上，完成下列任务：*** 

## (1) 建⽴与该数据集对应的视觉词典（码本），并可视化2～3个代表性码字，及与这些码字对应的实例图像局部图像块；（建议用SIFT特征，也可以用别的特征）（20分）

## (2) 进行基于BoW的图像识别或图像检索，并给出完整实验报告。（50分）

 

 

 

### 实验目的

1. 加深对Bag of words词袋模型在视觉领域中的理解。

2. 积累实际的Bag of words词袋模型应用经验。

 

### 实验步骤

1、 假设训练集有M幅图像[1]，对训练图象集进行预处理。包括图像增强，分割，图像统一格式，统一规格等等。

 

2、提取SIFT特征。对每一幅图像提取SIFT特征（每一幅图像提取多少个SIFT特征不定）。每一个SIFT特征用一个128维的描述子矢量表示，假设M幅图像共提取出N个SIFT特征。

 

3、用K-means对2中提取的N个SIFT特征进行聚类，K-Means算法是一种基于样本间相似性度量的间接聚类方法，此算法以K为参数，把N个对象分为K个簇，以使簇内具有较高的相似度，而簇间相似度较低。聚类中心有k个（在BOW模型中聚类中心我们称它们为视觉词），码本的长度也就为k，计算每一幅图像的每一个SIFT特征到这k个视觉词的距离，并将其映射到距离最近的视觉词中（即将该视觉词的对应词频+1）。完成这一步后，每一幅图像就变成了一个与视觉词序列相对应的词频矢量。

 

4、构造码本。码本矢量归一化因为每一幅图像的SIFT特征个数不定，所以需要归一化。测试图像也需经过预处理，提取SIFT特征，将这些特征映射到为码本矢量，码本矢量归一化，最后计算其与训练码本的距离，对应最近距离的训练图像认为与测试图像匹配。

实验数据记录、实验结果计算

本实验所有数据集和代码均已上传[Github](https://github.com/Kami-code)

 

### 实验结果

对视觉词进行可视化，并按照优先级排序，如下图所示。

![avatar](https://github.com/Kami-code/BoW/raw/master/DemoPicture1.png?raw=true)

通过视觉词计算测试集图片在每张训练集图片上的相似度（得分），并按照顺序输出。

  ![avatar](https://github.com/Kami-code/BoW/raw/master/DemoPicture2.png?raw=true)

通过搜索结果我们发现，每次搜索的结果均正确，故精确率为100%，在所有情况下，同一场景拍摄的不同图片排在最前，成功实现了图像检索的效果。

 

### 性能分析

在执行k-means聚类的过程中首先计算聚的k个类的聚类中心，然后用找到的k个聚类中心进行再次聚类。当聚类中心不再变动时，聚类停止。设此时迭代次数为t次。设单次计算两个SIFT特征的距离的消耗为d，所以k-means聚类复杂度为O(kNdt)。由于SIFT的描述子有128维度，可得k-means约需要10^12次计算。

在尝试进行可视化的过程中，遇到了一些性能的问题。假设有k个聚类中心，M幅图像共提取出N个SIFT特征。在实验中得知k≈10^3,N≈10^5，如果使用二重匹配匹配聚类中心最近的特征点作为数据可视化的依据，需要在O(kN)时间复杂度下进行≈10^8次图像的读写和掩膜操作。通过进一步的分析，我选用了kd树[2]这种数据结构进行优化。它是一种对k维空间中的实例点进行存储以便对其进行快速检索的树形数据结构。主要应用于多维空间关键数据的搜索（如：范围搜索和最近邻搜索），在通常情况下，kd树将查询最近邻的平均时间复杂度降低到了O(logN)，故总体上为O(klogN)，执行次数为17000次。

 

### 参考文献

[1]Do Better.BoW词袋模型原理学习及Python实现[EB/OL].https://blog.csdn.net/weixin_41234001/article/details/102913445,2019-11-05.
[2]百度百科.kd-tree[EB/OL].https://baike.baidu.com/item/kd-tree/2302515,2020-09-29.

 

运行环境
python2.7
opencv3.4
sklearn
numpy
matplotlib
首先训练模型，语法如下

文件的目录结构:
````
python searchFeatures.py -t 需要训练的图片文件夹路径
#例如python searchFeatures.py -t ../dataset/test/
````

进行查找，本程序只能每次查找一张图片，并返回与之匹配度（递减）最接近的6张图片
````bash
python query.py -i TestImgPath
#例如python query.py -i ../dataset/test/img.ppm
````

